#!/usr/bin/env bash

fail() {
    echo "$@" >&2
    exit 1
}

check_args() {
    [ $# != 1 ] && fail "ws requires exactly one argument"
    possible_names="travel dsi thesis uni dotfiles main"
    for name in $possible_names; do
        [ $name = "$1" ] && local match=
    done
    [ -v match ] || fail "ws only accepts '$possible_names'"
}

bind_ws_name() {
    mkdir -p ~/.cache/ws
    echo "$WS_NAME" > ~/.cache/ws/$(wmctrl -d | awk '/\*/{print $NF}')
}

change_directory() {
    [ -d "tubCloud/w21/$WS_NAME" ] && cd "tubCloud/w21/$WS_NAME"
}

launch_apps() {
    launch_tmux
    launch_browser
}

launch_tmux() {
    x-terminal-emulator -- tmux new-session -As "$WS_NAME" &
}

launch_browser() {
    firefox -P "$WS_NAME" &
    {
        sleep 4
        x-terminal-emulator &
        sleep 0.1
        kill $!
    } &
}

main() {
    check_args "$@"

    export WS_NAME="$1"
    cd

    bind_ws_name

    local script=".config/ws/$WS_NAME"
    [ -r "$script" ] && source "$script"

    change_directory
    export WS_HOME="$PWD"

    launch_apps
    exit 0
}
main "$@"
